# Подключаем библиотеки
library(quantmod)
library(writexl)
library(tidyverse)

start_date <- as.Date("2022-05-01")
end_date <- as.Date("2024-10-20")

# Функция для загрузки данных по одному тикеру
get_stock_data <- function(ticker) {
  tryCatch({
    data <- getSymbols(ticker, src = "yahoo", from = start_date, to = end_date, auto.assign = FALSE)
    # Оставляем только цены закрытия
    close_prices <- Cl(data)
    colnames(close_prices) <- ticker
    return(close_prices)
  }, error = function(e) {
    message(paste("Ошибка загрузки для", ticker))
    return(NULL)
  })
}

# Загрузка списка тикеров S&P 500 из открытого источника
#tickers <- c("AAPL", "MSFT", "AMZN", "GOOG", "TSLA", "NFLX", "NVDA", "ADBE", "PYPL", "V", "MA", "JNJ", "PG", "KO", "PEP", "MCD", "WMT", "HD", "LOW", "BA", "LMT", "RTX", "GE", "XOM", "CVX", "COP", "BP", "TTE", "INTC", "IBM", "CSCO", "ORCL", "CRM", "SAP", "T", "VZ", "CMCSA", "CHTR", "DIS", "NKE", "SBUX", "AXP", "GS", "MS", "BAC", "WFC", "C", "JPM", "PFE", "MRK", "BMY", "ABBV", "LLY", "NVS", "RHHBY", "AZN", "GSK", "SNY", "TM", "HMC", "NSANY", "VWAGY", "BMWYY", "EADSY", "SSNLF", "SONY", "HTHIY", "SIEGY", "BASFY", "BAYRY", "UL", "NSRGY", "BUD", "DEO", "DANOY", "ABNB", "UBER", "LYFT", "SHOP", "SQ", "ZM", "PLTR", "SNOW", "RBLX", "MRNA", "BNTX", "BYND", "SPOT", "TWLO", "OKTA", "CRWD", "DOCU", "DDOG", "ZS", "U")

tickers <- c("AAPL",
             "MSFT",
             "AMZN",
             "GOOGL",
             "FB",
             "TSLA",
             "BRK.B",
             "NVDA",
             "JNJ",
             "V",
             "UNH",
             "PG",
             "MA",
             "HD",
             "DIS",
             "PFE",
             "KO",
             "VZ",
             "NKE",
             "PEP",
             "CSCO",
             "XOM",
             "CMCSA",
             "T",
             "ORCL",
             "ABT",
             "TMO",
             "WMT",
             "INTC",
             "CRM",
             "NVS",
             "MRK",
             "AMGN",
             "QCOM",
             "AVGO",
             "HON",
             "TXN",
             "IBM",
             "SBUX",
             "LLY",
             "C",
             "BA",
             "MDT",
             "LMT",
             "PGR",
             "CVS",
             "DHR",
             "ADP",
             "FISV",
             "SCHW",
             "SYK",
             "FDX",
             "BKNG",
             "SPGI",
             "DISH",
             "VLO",
             "CAT",
             "AON",
             "MCO",
             "ADI",
             "LRCX",
             "APD",
             "KLAC",
             "AMAT",
             "HIG",
             "CFG",
             "MCD",
             "NOW",
             "KMB",
             "EXC",
             "SRE",
             "SO",
             "NEM",
             "PXD",
             "VRTX",
             "CARR",
             "TEL",
             "GWW",
             "MAS",
             "WBA",
             "JCI",
             "FIS",
             "BAX",
             "DOV",
             "AEP",
             "NDAQ",
             "SYY",
             "HSY",
             "RMD",
             "BMY",
             "ADUS",
             "PRGO",
             "WST",
             "GLW",
             "HBAN",
             "OMC",
             "AMCR",
             "URI",
             "KMX",
             "ZBRA",
             "ANSS",
             "ALGN",
             "CDW",
             "TTWO",
             "SBAC",
             "VTRS",
             "CNC",
             "HST",
             "WRB",
             "ICE",
             "SIVB",
             "PKG",
             "DG",
             "CZR",
             "DXCM",
             "VFC",
             "PVH",
             "DXCM",
             "FITB",
             "LNT",
             "LNT",
             "CMS",
             "ARE",
             "ALK",
             "WST",
             "MSI",
             "SYY",
             "CHRW",
             "YUM",
             "ADSK",
             "IP",
             "MORN",
             "MAS",
             "SPLK",
             "ETR",
             "CMS",
             "HSIC",
             "SBNY",
             "CARR",
             "DLTR",
             "VTR",
             "APTV",
             "HWM",
             "NDAQ",
             "ALB",
             "BHP",
             "BDX",
             "CPB",
             "GRMN",
             "HSY",
             "IAC",
             "KMI",
             "LIN",
             "ODFL",
             "CHKP",
             "FAST",
             "NTRS",
             "PH",
             "SRE",
             "NDAQ",
             "TROW",
             "OMI",
             "SJM",
             "IPG",
             "APD",
             "RCL",
             "FDX",
             "NKE",
             "PAYX",
             "TRV",
             "PPG",
             "GLW",
             "VRSN",
             "SRE",
             "QRVO",
             "CNTY",
             "CDK",
             "AVY",
             "MET",
             "CL",
             "ANET",
             "AVY",
             "TFX",
             "ODP",
             "VRSN",
             "LDOS",
             "WHR",
             "BRK.A",
             "CAG",
             "NDAQ",
             "NDAQ",
             "COTY",
             "CHRW",
             "REXR",
             "DOV",
             "REG",
             "PHM",
             "WSM",
             "TDY",
             "SMG",
             "ESS",
             "PAYC",
             "VEEV",
             "EVRG",
             "JCI",
             "EQH",
             "LNT",
             "NWL",
             "VTR",
             "NDAQ",
             "VTR",
             "JCI",
             "PH",
             "PGRE",
             "AMCR",
             "DRE",
             "STX",
             "WSM",
             "ALGN",
             "STT",
             "FITB",
             "TPR",
             "SEE",
             "HWM",
             "FANG",
             "SHW",
             "NDAQ",
             "YUM",
             "ADSK",
             "IP",
             "MORN",
             "MAS",
             "SPLK",
             "ETR",
             "CMS",
             "HSIC",
             "SBNY",
             "CARR",
             "DLTR",
             "VTR",
             "APTV",
             "HWM",
             "NDAQ",
             "ALB",
             "BHP",
             "BDX",
             "CPB",
             "GRMN",
             "HSY",
             "IAC",
             "KMI",
             "LIN",
             "ODFL",
             "CHKP",
             "FAST",
             "NTRS",
             "PH",
             "SRE",
             "NDAQ",
             "TROW",
             "OMI",
             "SJM",
             "IPG",
             "APD",
             "RCL",
             "FDX",
             "NKE",
             "PAYX",
             "TRV",
             "PPG",
             "GLW",
             "VRSN",
             "SRE",
             "QRVO",
             "CNTY",
             "CDK",
             "AVY",
             "MET",
             "CL",
             "ANET",
             "AVY",
             "TFX",
             "ODP",
             "VRSN",
             "LDOS",
             "WHR",
             "BRK.A",
             "CAG",
             "NDAQ",
             "COTY",
             "CHRW",
             "REXR",
             "DOV",
             "REG",
             "PHM",
             "WSM",
             "TDY",
             "SMG",
             "ESS",
             "PAYC",
             "VEEV",
             "EVRG",
             "JCI",
             "EQH",
             "LNT",
             "NWL",
             "VTR",
             "NDAQ",
             "VTR",
             "JCI",
             "PH",
             "PGRE",
             "AMCR",
             "DRE",
             "STX",
             "WSM",
             "ALGN",
             "STT",
             "FITB",
             "TPR",
             "SEE",
             "HWM",
             "FANG",
             "SHW",
             "NDAQ",
             "YUM",
             "ADSK",
             "IP",
             "MORN",
             "MAS",
             "SPLK",
             "ETR",
             "CMS",
             "HSIC",
             "SBNY",
             "CARR",
             "DLTR",
             "VTR",
             "APTV",
             "HWM",
             "NDAQ",
             "ALB",
             "BHP",
             "BDX",
             "CPB",
             "GRMN",
             "HSY",
             "IAC",
             "KMI",
             "LIN",
             "ODFL",
             "CHKP",
             "FAST",
             "NTRS",
             "PH",
             "SRE",
             "NDAQ",
             "TROW",
             "OMI",
             "SJM",
             "IPG",
             "APD",
             "RCL",
             "FDX",
             "NKE",
             "PAYX",
             "TRV",
             "PPG",
             "GLW",
             "VRSN",
             "SRE",
             "QRVO",
             "CNTY",
             "CDK",
             "AVY",
             "MET",
             "CL",
             "ANET",
             "AVY",
             "TFX",
             "ODP",
             "VRSN",
             "LDOS",
             "WHR",
             "BRK.A",
             "CAG",
             "NDAQ",
             "COTY",
             "CHRW",
             "REXR",
             "DOV",
             "REG",
             "PHM",
             "WSM",
             "TDY",
             "SMG",
             "ESS",
             "PAYC",
             "VEEV",
             "EVRG",
             "JCI",
             "EQH",
             "LNT",
             "NWL",
             "VTR",
             "NDAQ",
             "VTR",
             "JCI",
             "PH",
             "PGRE",
             "AMCR",
             "DRE",
             "STX",
             "WSM",
             "ALGN",
             "STT",
             "FITB",
             "TPR",
             "SEE",
             "HWM",
             "FANG",
             "SHW",
             "NDAQ",
             "YUM",
             "ADSK",
             "IP",
             "MORN",
             "MAS",
             "SPLK",
             "ETR",
             "CMS",
             "HSIC",
             "SBNY",
             "CARR",
             "DLTR",
             "VTR",
             "APTV"
)

# Получаем цены закрытия для всех акций S&P 500
all_prices <- lapply(tickers, get_stock_data) %>% 
  keep(~ !is.null(.)) %>%  # Убираем тикеры, для которых данные не были получены
  reduce(merge)             # Объединяем все данные в один датафрейм

df <- as.data.frame(all_prices)

summary(df)
is.na(df)
na.omit(df)
# Сохраняем данные в Excel
write_xlsx(as.data.frame(all_prices), "closing_prices_Foreign_2022-2024.xlsx")
write_xlsx(as.data.frame(all_prices), "closing_prices_Foreign_new_2022-2024.xlsx")
